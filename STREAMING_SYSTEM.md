# TG Book Reader - Потоковая система

## Обзор изменений

Система была обновлена для решения проблемы с новыми пользователями. Теперь приложение работает в режиме потоковой передачи файлов без сохранения их локально.

## Ключевые изменения

### 1. Потоковая передача файлов
- Файлы больше не сохраняются на диск сервера
- PDF передаются напрямую из Telegram Bot API в браузер
- Экономия места на диске и улучшенная безопасность

### 2. Работа с новыми пользователями
- Новые пользователи сразу видят свои загруженные книги
- Не требуется создание локальных папок
- Система работает для всех пользователей одинаково

### 3. Гибридная система
- Приоритет: потоковая передача из Telegram
- Fallback: локальное сохранение (если веб-приложение недоступно)
- Совместимость с существующими локальными файлами

## Архитектура

```
Пользователь → Telegram Bot → Веб-приложение → Браузер
                    ↓              ↓
              Информация о файле  Потоковая передача
              (file_id, имя)      (StreamingResponse)
```

## API Endpoints

### Новые endpoints:
- `POST /api/add-file` - Добавление информации о файле
- `GET /stream/{file_id}` - Потоковая передача файла из Telegram

### Обновленные endpoints:
- `GET /api/books` - Возвращает книги с file_id для потоковой передачи
- `GET /view/{filename}` - Поддерживает file_id для потоковой передачи

## Установка и запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте переменные окружения в `.env`:
```
BOT_TOKEN=your_telegram_bot_token
WEBAPP_URL=http://localhost:8000/
BOOKS_DIR=./books
```

3. Запустите веб-приложение:
```bash
cd app
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

4. Запустите бота:
```bash
cd bot
python main.py
```

## Тестирование

Запустите тестовый скрипт для проверки работы системы:
```bash
python test_system.py
```

## Преимущества новой системы

1. **Для новых пользователей**: Книги отображаются сразу после загрузки
2. **Экономия места**: Файлы не занимают место на сервере
3. **Безопасность**: Файлы не хранятся локально
4. **Производительность**: Потоковая передача быстрее загрузки с диска
5. **Масштабируемость**: Система работает с любым количеством пользователей

## Совместимость

- ✅ Новые пользователи работают без проблем
- ✅ Существующие локальные файлы продолжают работать
- ✅ Fallback на локальное сохранение при недоступности веб-приложения
- ✅ Поддержка всех существующих функций

## Устранение неполадок

### Проблема: Книги не отображаются у новых пользователей
**Решение**: Убедитесь, что веб-приложение запущено и доступно по адресу из WEBAPP_URL

### Проблема: Ошибка при потоковой передаче
**Решение**: Проверьте BOT_TOKEN и доступность Telegram Bot API

### Проблема: Файлы сохраняются локально
**Решение**: Это нормальное поведение при недоступности веб-приложения (fallback режим)
